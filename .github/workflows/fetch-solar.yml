name: Fetch Solar Conditions

on:
  schedule:
    # Run every hour at minute 0
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  fetch-solar-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests
          
      - name: Fetch and parse solar data
        run: |
          python - <<EOF
          import requests
          import json
          import xml.etree.ElementTree as ET
          from datetime import datetime

          # Fetch XML data
          response = requests.get('https://www.hamqsl.com/solarxml.php')
          response.raise_for_status()
          
          # Parse XML
          root = ET.fromstring(response.content)
          solardata = root.find('.//solardata')
          
          # Extract data
          solar_data = {
              'updated_at': datetime.utcnow().isoformat() + 'Z',
              'solar': {
                  'sunspots': solardata.find('sunspots').text if solardata.find('sunspots') is not None else 'N/A',
                  'solarflux': solardata.find('solarflux').text if solardata.find('solarflux') is not None else 'N/A',
                  'aindex': solardata.find('aindex').text if solardata.find('aindex') is not None else 'N/A',
                  'kindex': solardata.find('kindex').text if solardata.find('kindex') is not None else 'N/A',
                  'solarwind': solardata.find('solarwind').text if solardata.find('solarwind') is not None else 'N/A',
                  'signalnoise': solardata.find('signalnoise').text if solardata.find('signalnoise') is not None else 'N/A',
                  'xray': solardata.find('xray').text if solardata.find('xray') is not None else 'N/A',
                  'geomagfield': solardata.find('geomagfield').text if solardata.find('geomagfield') is not None else 'N/A',
                  'electonflux': solardata.find('electonflux').text if solardata.find('electonflux') is not None else 'N/A',
                  'protonflux': solardata.find('protonflux').text if solardata.find('protonflux') is not None else 'N/A'
              },
              'hf_bands': {}
          }
          
          # Parse calculated conditions - new structure
          calc_conditions = solardata.find('.//calculatedconditions')
          if calc_conditions is not None:
              # Create a dictionary to organize by band name
              bands_dict = {}
              for band in calc_conditions.findall('band'):
                  band_name = band.get('name')
                  time_period = band.get('time')
                  condition = band.text
                  
                  if band_name not in bands_dict:
                      bands_dict[band_name] = {}
                  bands_dict[band_name][time_period] = condition
              
              # Convert to expected format
              solar_data['hf_bands'] = {
                  '80m_40m': bands_dict.get('80m-40m', {'day': 'Poor', 'night': 'Poor'}),
                  '30m_20m': bands_dict.get('30m-20m', {'day': 'Poor', 'night': 'Poor'}),
                  '17m_15m': bands_dict.get('17m-15m', {'day': 'Poor', 'night': 'Poor'}),
                  '12m_10m': bands_dict.get('12m-10m', {'day': 'Poor', 'night': 'Poor'})
              }
          else:
              # Fallback to default Poor conditions
              solar_data['hf_bands'] = {
                  '80m_40m': {'day': 'Poor', 'night': 'Poor'},
                  '30m_20m': {'day': 'Poor', 'night': 'Poor'},
                  '17m_15m': {'day': 'Poor', 'night': 'Poor'},
                  '12m_10m': {'day': 'Poor', 'night': 'Poor'}
              }
          
          # Save to JSON file
          with open('solar-conditions.json', 'w') as f:
              json.dump(solar_data, f, indent=2)
          
          print("Solar data fetched and saved successfully!")
          print(json.dumps(solar_data, indent=2))
          EOF
          
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add solar-conditions.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update solar conditions data" && git push)
